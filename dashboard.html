<script>
    let currentUser = null;
    
    // Menu mobile
    document.getElementById('mobileMenuBtn').addEventListener('click', function() {
        const mobileNav = document.getElementById('mobileNav');
        const userInfo = document.getElementById('desktopUserInfo');
        
        mobileNav.classList.toggle('active');
        userInfo.classList.toggle('active');
    });
    
    // Verificar autentica√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
        const userData = localStorage.getItem('currentUser');
        
        if (!userData) {
            window.location.href = '/login';
            return;
        }
        
        currentUser = JSON.parse(userData);
        
        // Se for admin, redirecionar para √°rea administrativa
        if (currentUser.isAdmin) {
            window.location.href = '/admin';
            return;
        }
        
        atualizarAvatar();
        carregarRegistros();
        
        // Definir data atual como padr√£o no modal
        document.getElementById('dataHoraExtra').value = new Date().toISOString().split('T')[0];
    });
    
    // Atualizar avatar no header
    function atualizarAvatar() {
        const avatarElement = document.getElementById('userAvatar');
        const mobileAvatarElement = document.getElementById('mobileUserAvatar');
        
        if (currentUser.avatar) {
            avatarElement.innerHTML = `<img src="${currentUser.avatar}" alt="${currentUser.nome}">`;
            mobileAvatarElement.innerHTML = `<img src="${currentUser.avatar}" alt="${currentUser.nome}">`;
        } else {
            // Usar iniciais do nome
            const iniciais = currentUser.nome.split(' ').map(n => n[0]).join('').toUpperCase();
            avatarElement.textContent = iniciais.substring(0, 2);
            mobileAvatarElement.textContent = iniciais.substring(0, 2);
        }
    }
    
    // Registrar ponto - CORRIGIDA
    async function registrarPonto() {
        const loading = document.getElementById('loadingPonto');
        const btnRegistrar = document.getElementById('btnRegistrar');
        
        // Validar local
        const localInput = document.getElementById('localTrabalho');
        const local = localInput.value.trim();
        
        if (!local) {
            showAlert('Por favor, informe o local de trabalho.', 'error');
            return;
        }
        
        // Desabilitar bot√µes
        btnRegistrar.disabled = true;
        loading.style.display = 'block';
        
        try {
            const agora = new Date();
            const tipoPonto = calcularTipoPonto(agora);
            
            console.log('‚è∞ Enviando registro de ponto...');
            
            const response = await fetch('/api/registrar-ponto', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    usuario_id: currentUser.id,
                    tipo: tipoPonto.tipo,
                    local: local,
                    observacao: tipoPonto.observacao
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert(`‚úÖ Ponto registrado com sucesso! (${tipoPonto.tipo})`, 'success');
                carregarRegistros();
                localInput.value = ''; // Limpar campo
            } else {
                showAlert(`‚ùå ${data.error}`, 'error');
            }
        } catch (error) {
            console.error('üí• Erro:', error);
            showAlert('‚ùå Erro de conex√£o. Tente novamente.', 'error');
        } finally {
            btnRegistrar.disabled = false;
            loading.style.display = 'none';
        }
    }
    
    // Calcular tipo de ponto baseado no hor√°rio
    function calcularTipoPonto(data) {
        const hora = data.getHours();
        const minutos = data.getMinutes();
        
        let tipo = 'entrada';
        let observacao = '';
        
        if (hora >= 12) {
            tipo = 'saida';
            observacao = 'Sa√≠da regular';
        } else {
            tipo = 'entrada';
            observacao = 'Entrada regular';
        }
        
        return { tipo, observacao };
    }
    
    // Abrir modal para hora extra
    function abrirModalHoraExtra() {
        document.getElementById('modalHoraExtra').style.display = 'block';
    }
    
    // Fechar modal para hora extra
    function fecharModalHoraExtra() {
        document.getElementById('modalHoraExtra').style.display = 'none';
    }
    
    // Registrar hora extra - CORRIGIDA
    async function registrarHoraExtra() {
        const data = document.getElementById('dataHoraExtra').value;
        const horaEntrada = document.getElementById('horaEntradaExtra').value;
        const horaSaida = document.getElementById('horaSaidaExtra').value;
        const local = document.getElementById('localHoraExtra').value.trim();
        
        if (!data || !horaEntrada || !horaSaida || !local) {
            showAlert('‚ùå Por favor, preencha todos os campos.', 'error');
            return;
        }
        
        if (horaEntrada >= horaSaida) {
            showAlert('‚ùå A hora de entrada deve ser anterior √† hora de sa√≠da.', 'error');
            return;
        }
        
        try {
            console.log('‚≠ê Registrando hora extra...');
            
            // Registrar entrada extra
            const responseEntrada = await fetch('/api/registrar-ponto', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    usuario_id: currentUser.id,
                    tipo: 'entrada_extra',
                    local: local,
                    horas_extras: true,
                    observacao: 'Hora extra - entrada',
                    manual: true
                })
            });
            
            const dataEntrada = await responseEntrada.json();
            
            if (!dataEntrada.success) {
                showAlert(`‚ùå ${dataEntrada.error}`, 'error');
                return;
            }
            
            // Registrar sa√≠da extra
            const responseSaida = await fetch('/api/registrar-ponto', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    usuario_id: currentUser.id,
                    tipo: 'saida_extra',
                    local: local,
                    horas_extras: true,
                    observacao: 'Hora extra - sa√≠da',
                    manual: true
                })
            });
            
            const dataSaida = await responseSaida.json();
            
            if (dataSaida.success) {
                showAlert('‚úÖ Hora extra registrada com sucesso!', 'success');
                fecharModalHoraExtra();
                carregarRegistros();
                
                // Limpar campos do modal
                document.getElementById('horaEntradaExtra').value = '';
                document.getElementById('horaSaidaExtra').value = '';
                document.getElementById('localHoraExtra').value = '';
                
            } else {
                showAlert(`‚ùå ${dataSaida.error}`, 'error');
            }
            
        } catch (error) {
            console.error('üí• Erro:', error);
            showAlert('‚ùå Erro de conex√£o. Tente novamente.', 'error');
        }
    }
    
    // Carregar registros do usu√°rio - CORRIGIDA
    async function carregarRegistros() {
        const loading = document.getElementById('loadingRegistros');
        const registrosList = document.getElementById('registrosList');
        
        loading.style.display = 'block';
        registrosList.innerHTML = '';
        
        try {
            console.log('üìã Carregando registros...');
            
            const response = await fetch(`/api/registros/${currentUser.id}`);
            const data = await response.json();
            
            if (data.success) {
                atualizarEstatisticas(data.registros);
                
                if (data.registros.length === 0) {
                    registrosList.innerHTML = `
                        <div class="empty-state">
                            <p>Nenhum registro encontrado.</p>
                            <p>Registre seu primeiro ponto acima!</p>
                        </div>
                    `;
                } else {
                    data.registros.forEach(registro => {
                        const tipoDisplay = {
                            'entrada': 'üü¢ Entrada',
                            'saida': 'üî¥ Sa√≠da',
                            'entrada_extra': 'üîµ Entrada Extra',
                            'saida_extra': 'üü£ Sa√≠da Extra'
                        }[registro.tipo] || registro.tipo;
                        
                        const tipoClass = registro.tipo.includes('entrada') ? 'entrada' : 'saida';
                        
                        const registroElement = document.createElement('div');
                        registroElement.className = 'registro-item';
                        registroElement.innerHTML = `
                            <div class="registro-info">
                                <h4>${tipoDisplay}</h4>
                                <div class="registro-meta">
                                    ${registro.data} √†s ${registro.hora} - ${registro.diaSemana}
                                    ${registro.local ? `<br>üìç ${registro.local}` : ''}
                                    ${registro.observacao ? `<br>üìù ${registro.observacao}` : ''}
                                    ${registro.horas_extras ? '<br>‚ö° Horas Extras' : ''}
                                    ${registro.manual ? '<br>‚úèÔ∏è Registro Manual' : ''}
                                </div>
                            </div>
                            <div class="registro-tipo tipo-${tipoClass}">
                                ${registro.tipo.toUpperCase()}
                            </div>
                        `;
                        registrosList.appendChild(registroElement);
                    });
                }
            } else {
                showAlert(`‚ùå ${data.error}`, 'error');
            }
        } catch (error) {
            console.error('üí• Erro:', error);
            showAlert('‚ùå Erro ao carregar registros.', 'error');
        } finally {
            loading.style.display = 'none';
        }
    }
    
    // Atualizar estat√≠sticas
    function atualizarEstatisticas(registros) {
        const horasExtrasCount = registros.filter(r => r.horas_extras).length;
        document.getElementById('horasExtrasCount').textContent = horasExtrasCount;
    }
    
    // Mostrar alertas
    function showAlert(message, type) {
        const alert = document.getElementById('alert');
        alert.textContent = message;
        alert.className = `alert alert-${type}`;
        alert.style.display = 'block';
        
        // Auto-esconder ap√≥s 5 segundos
        setTimeout(() => {
            alert.style.display = 'none';
        }, 5000);
    }
    
    // Logout
    function logout() {
        localStorage.removeItem('currentUser');
        window.location.href = '/';
    }
    
    // Fechar modal ao clicar fora
    window.onclick = function(event) {
        const modal = document.getElementById('modalHoraExtra');
        if (event.target === modal) {
            fecharModalHoraExtra();
        }
    }
</script>