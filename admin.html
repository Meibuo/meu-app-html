<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Sistema de Ponto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            background: #2c3e50;
            color: white;
            height: 100vh;
            position: fixed;
            width: 250px;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        .nav-link {
            color: #bdc3c7;
            padding: 15px 20px;
            border-left: 4px solid transparent;
        }
        .nav-link:hover, .nav-link.active {
            color: white;
            background: #34495e;
            border-left-color: #3498db;
        }
        .nav-link i {
            width: 20px;
            margin-right: 10px;
        }
        .stats-card {
            border-radius: 10px;
            border: none;
            color: white;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            transition: all 0.3s ease;
        }
        #alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
        }
        .badge-admin {
            background: linear-gradient(45deg, #FFD700, #FFA500);
        }
        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-3">
            <h4><i class="fas fa-crown"></i> Painel Admin</h4>
            <hr>
        </div>
        <nav class="nav flex-column">
            <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a class="nav-link" href="#" onclick="showSection('usuarios')">
                <i class="fas fa-users"></i> Gerenciar Usu√°rios
            </a>
            <a class="nav-link" href="#" onclick="showSection('registros')">
                <i class="fas fa-history"></i> Todos os Registros
            </a>
            <a class="nav-link" href="#" onclick="showSection('relatorios')">
                <i class="fas fa-chart-bar"></i> Relat√≥rios
            </a>
            <hr>
            <a class="nav-link text-danger" href="#" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Sair
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Alert Container -->
        <div id="alert-container"></div>

        <!-- Dashboard Section -->
        <div id="dashboard-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard Administrativo</h2>
                <span id="admin-name" class="text-muted">Carregando...</span>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stats-card bg-primary card-hover">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h3 id="total-users">0</h3>
                                    <p class="mb-0">Total Usu√°rios</p>
                                </div>
                                <i class="fas fa-users fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card bg-success card-hover">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h3 id="total-registros">0</h3>
                                    <p class="mb-0">Total Registros</p>
                                </div>
                                <i class="fas fa-list fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card bg-warning card-hover">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h3 id="registros-hoje">0</h3>
                                    <p class="mb-0">Registros Hoje</p>
                                </div>
                                <i class="fas fa-calendar-day fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card bg-info card-hover">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h3 id="admin-users">0</h3>
                                    <p class="mb-0">Administradores</p>
                                </div>
                                <i class="fas fa-crown fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="fas fa-bolt"></i> A√ß√µes R√°pidas</h5>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-success me-2" onclick="showSection('usuarios'); document.getElementById('btn-novo-usuario').click();">
                                <i class="fas fa-user-plus"></i> Novo Usu√°rio
                            </button>
                            <button class="btn btn-primary me-2" onclick="showSection('registros')">
                                <i class="fas fa-search"></i> Ver Registros
                            </button>
                            <div class="export-buttons mt-2">
                                <button class="btn btn-info" onclick="exportarDadosExcel()">
                                    <i class="fas fa-file-excel"></i> Exportar Excel
                                </button>
                                <button class="btn btn-danger" onclick="exportarDadosPDF()">
                                    <i class="fas fa-file-pdf"></i> Exportar PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Usu√°rios Section -->
        <div id="usuarios-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-users"></i> Gerenciar Usu√°rios</h2>
                <button class="btn btn-success" id="btn-novo-usuario" data-bs-toggle="modal" data-bs-target="#modalUsuario">
                    <i class="fas fa-user-plus"></i> Novo Usu√°rio
                </button>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>E-mail</th>
                                    <th>Telefone</th>
                                    <th>Cargo</th>
                                    <th>Status</th>
                                    <th>Cadastro</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="usuarios-body">
                                <!-- Usu√°rios ser√£o carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Registros Section -->
        <div id="registros-section" style="display: none;">
            <h2 class="mb-4"><i class="fas fa-history"></i> Todos os Registros</h2>
            
            <div class="card">
                <div class="card-header">
                    <div class="row">
                        <div class="col-md-4">
                            <select class="form-select" id="filter-user">
                                <option value="">Todos os usu√°rios</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="filter-start">
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="filter-end">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="carregarRegistrosAdmin()">
                                <i class="fas fa-filter"></i> Filtrar
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Usu√°rio</th>
                                    <th>Data</th>
                                    <th>Hora Entrada</th>
                                    <th>Hora Sa√≠da</th>
                                    <th>Local</th>
                                    <th>Observa√ß√£o</th>
                                    <th>Horas Extras</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="registros-admin-body">
                                <!-- Registros ser√£o carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Relat√≥rios Section -->
        <div id="relatorios-section" style="display: none;">
            <h2 class="mb-4"><i class="fas fa-chart-bar"></i> Relat√≥rios</h2>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Relat√≥rios Avan√ßados</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h5><i class="fas fa-chart-line text-primary"></i> Relat√≥rio de Frequ√™ncia</h5>
                                    <p class="text-muted">Relat√≥rio detalhado de frequ√™ncia por per√≠odo</p>
                                    <button class="btn btn-primary" onclick="gerarRelatorioFrequencia()">
                                        <i class="fas fa-download"></i> Gerar Relat√≥rio
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h5><i class="fas fa-clock text-warning"></i> Relat√≥rio de Horas Extras</h5>
                                    <p class="text-muted">Relat√≥rio consolidado de horas extras</p>
                                    <button class="btn btn-warning" onclick="gerarRelatorioHorasExtras()">
                                        <i class="fas fa-download"></i> Gerar Relat√≥rio
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6>Filtros do Relat√≥rio</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="relatorio-usuario" class="form-label">Usu√°rio</label>
                                            <select class="form-select" id="relatorio-usuario">
                                                <option value="">Todos os usu√°rios</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="relatorio-data-inicio" class="form-label">Data In√≠cio</label>
                                            <input type="date" class="form-control" id="relatorio-data-inicio">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="relatorio-data-fim" class="form-label">Data Fim</label>
                                            <input type="date" class="form-control" id="relatorio-data-fim">
                                        </div>
                                        <div class="col-md-2 d-flex align-items-end">
                                            <button class="btn btn-success w-100" onclick="gerarRelatorioCompleto()">
                                                <i class="fas fa-file-alt"></i> Gerar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Usu√°rio -->
    <div class="modal fade" id="modalUsuario" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalUsuarioTitle">Novo Usu√°rio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-usuario">
                        <input type="hidden" id="usuario-id">
                        <div class="mb-3">
                            <label for="nome" class="form-label">Nome *</label>
                            <input type="text" class="form-control" id="nome" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">E-mail *</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="telefone" class="form-label">Telefone</label>
                            <input type="tel" class="form-control" id="telefone">
                        </div>
                        <div class="mb-3">
                            <label for="cargo" class="form-label">Cargo</label>
                            <input type="text" class="form-control" id="cargo" value="Terceiro">
                        </div>
                        <div class="mb-3">
                            <label for="senha" class="form-label">Senha *</label>
                            <input type="password" class="form-control" id="senha" required minlength="6">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="is-admin">
                            <label class="form-check-label" for="is-admin">
                                √â administrador
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarUsuario()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Registro -->
    <div class="modal fade" id="modalEditarRegistro" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Registro de Ponto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-editar-registro">
                        <input type="hidden" id="registro-id">
                        <div class="mb-3">
                            <label for="edit-data" class="form-label">Data</label>
                            <input type="date" class="form-control" id="edit-data">
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="edit-hora-entrada" class="form-label">Hora Entrada</label>
                                <input type="time" class="form-control" id="edit-hora-entrada">
                            </div>
                            <div class="col-md-6">
                                <label for="edit-hora-saida" class="form-label">Hora Sa√≠da</label>
                                <input type="time" class="form-control" id="edit-hora-saida">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="edit-local" class="form-label">Local</label>
                            <input type="text" class="form-control" id="edit-local">
                        </div>
                        <div class="mb-3">
                            <label for="edit-observacao" class="form-label">Observa√ß√£o</label>
                            <textarea class="form-control" id="edit-observacao" rows="3"></textarea>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="edit-horas-extras">
                            <label class="form-check-label" for="edit-horas-extras">
                                Horas Extras
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarEdicaoRegistro()">Salvar Altera√ß√µes</button>
                    <button type="button" class="btn btn-danger" onclick="excluirRegistroAdmin()">Excluir Registro</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ========== FUN√á√ïES DO PAINEL ADMIN ==========

        // Verificar autentica√ß√£o e admin
        document.addEventListener('DOMContentLoaded', function() {
            const usuario = JSON.parse(localStorage.getItem('usuario'));
            if (!usuario || !usuario.isAdmin) {
                window.location.href = 'login';
                return;
            }

            document.getElementById('admin-name').textContent = usuario.nome;
            carregarEstatisticas();
            carregarUsuarios();
            carregarRegistrosAdmin();
        });

        // Fun√ß√µes de navega√ß√£o
        function showSection(sectionName) {
            // Esconder todas as sections
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('usuarios-section').style.display = 'none';
            document.getElementById('registros-section').style.display = 'none';
            document.getElementById('relatorios-section').style.display = 'none';
            
            // Mostrar section selecionada
            document.getElementById(sectionName + '-section').style.display = 'block';
            
            // Atualizar menu
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Carregar estat√≠sticas do sistema
        async function carregarEstatisticas() {
            try {
                const response = await fetch('/api/admin/estatisticas');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('total-users').textContent = data.estatisticas.totalUsers;
                    document.getElementById('admin-users').textContent = data.estatisticas.totalAdmins;
                    document.getElementById('total-registros').textContent = data.estatisticas.totalRegistros;
                    document.getElementById('registros-hoje').textContent = data.estatisticas.registrosHoje;
                }
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
                showAlert('‚ùå Erro ao carregar estat√≠sticas', 'danger');
            }
        }

        // Carregar lista de usu√°rios
        async function carregarUsuarios() {
            try {
                const response = await fetch('/api/admin/usuarios');
                const data = await response.json();
                
                if (data.success) {
                    exibirUsuarios(data.usuarios);
                    popularFiltroUsuarios(data.usuarios);
                    popularFiltroRelatorioUsuarios(data.usuarios);
                } else {
                    console.error('Erro na resposta da API:', data);
                    showAlert('‚ùå Erro ao carregar usu√°rios: ' + (data.error || 'Erro desconhecido'), 'danger');
                }
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                showAlert('‚ùå Erro ao carregar usu√°rios: ' + error.message, 'danger');
            }
        }

        // Exibir usu√°rios na tabela
        function exibirUsuarios(usuarios) {
            const tbody = document.getElementById('usuarios-body');
            
            if (usuarios.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-users fa-2x mb-2"></i><br>
                            Nenhum usu√°rio encontrado
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = usuarios.map(usuario => `
                <tr>
                    <td>
                        <strong>${usuario.nome}</strong>
                        ${usuario.isAdmin ? '<span class="badge bg-warning ms-1">Admin</span>' : ''}
                    </td>
                    <td>${usuario.email}</td>
                    <td>${usuario.telefone || '-'}</td>
                    <td>${usuario.cargo}</td>
                    <td>
                        <span class="badge ${usuario.status === 'ativo' ? 'bg-success' : 'bg-secondary'}">
                            ${usuario.status}
                        </span>
                    </td>
                    <td>${new Date(usuario.criadoEm).toLocaleDateString('pt-BR')}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editarUsuario('${usuario.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="redefinirSenha('${usuario.id}')">
                            <i class="fas fa-key"></i>
                        </button>
                        ${!usuario.isAdmin ? `
                            <button class="btn btn-sm btn-outline-danger" onclick="excluirUsuario('${usuario.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // Popular filtro de usu√°rios
        function popularFiltroUsuarios(usuarios) {
            const select = document.getElementById('filter-user');
            select.innerHTML = '<option value="">Todos os usu√°rios</option>';
            
            usuarios.forEach(usuario => {
                select.innerHTML += `<option value="${usuario.id}">${usuario.nome}</option>`;
            });
        }

        // Popular filtro de relat√≥rios
        function popularFiltroRelatorioUsuarios(usuarios) {
            const select = document.getElementById('relatorio-usuario');
            select.innerHTML = '<option value="">Todos os usu√°rios</option>';
            
            usuarios.forEach(usuario => {
                select.innerHTML += `<option value="${usuario.id}">${usuario.nome}</option>`;
            });
        }

        // Abrir modal para novo usu√°rio
        function novoUsuario() {
            document.getElementById('modalUsuarioTitle').textContent = 'Novo Usu√°rio';
            document.getElementById('form-usuario').reset();
            document.getElementById('usuario-id').value = '';
            document.getElementById('senha').required = true;
            document.getElementById('senha').placeholder = '';
        }

        // Editar usu√°rio
        async function editarUsuario(usuarioId) {
            try {
                const response = await fetch('/api/admin/usuarios');
                const data = await response.json();
                
                if (data.success) {
                    const usuarioEditar = data.usuarios.find(u => u.id === usuarioId);
                    if (usuarioEditar) {
                        document.getElementById('modalUsuarioTitle').textContent = 'Editar Usu√°rio';
                        document.getElementById('usuario-id').value = usuarioEditar.id;
                        document.getElementById('nome').value = usuarioEditar.nome;
                        document.getElementById('email').value = usuarioEditar.email;
                        document.getElementById('telefone').value = usuarioEditar.telefone || '';
                        document.getElementById('cargo').value = usuarioEditar.cargo;
                        document.getElementById('is-admin').checked = usuarioEditar.isAdmin;
                        document.getElementById('senha').required = false;
                        document.getElementById('senha').placeholder = 'Deixe em branco para manter a senha atual';
                        
                        const modal = new bootstrap.Modal(document.getElementById('modalUsuario'));
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar usu√°rio:', error);
                showAlert('‚ùå Erro ao carregar usu√°rio', 'danger');
            }
        }

        // Salvar usu√°rio (criar ou editar)
        async function salvarUsuario() {
            try {
                const formData = {
                    nome: document.getElementById('nome').value,
                    email: document.getElementById('email').value,
                    telefone: document.getElementById('telefone').value,
                    cargo: document.getElementById('cargo').value,
                    isAdmin: document.getElementById('is-admin').checked
                };

                // Adicionar senha apenas se for novo usu√°rio ou se foi preenchida
                const senha = document.getElementById('senha').value;
                const usuarioId = document.getElementById('usuario-id').value;
                
                if (!usuarioId && !senha) {
                    showAlert('‚ùå Senha √© obrigat√≥ria para novo usu√°rio', 'warning');
                    return;
                }

                if (senha) {
                    formData.senha = senha;
                }

                let response;
                if (usuarioId) {
                    // Editar usu√°rio existente
                    response = await fetch(`/api/admin/usuarios/${usuarioId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                } else {
                    // Criar novo usu√°rio
                    response = await fetch('/api/admin/cadastro', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                }

                const data = await response.json();

                if (data.success) {
                    showAlert('‚úÖ ' + data.message, 'success');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalUsuario'));
                    modal.hide();
                    carregarUsuarios();
                    carregarEstatisticas();
                } else {
                    showAlert('‚ùå ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('Erro ao salvar usu√°rio:', error);
                showAlert('‚ùå Erro ao salvar usu√°rio', 'danger');
            }
        }

        // Excluir usu√°rio
        async function excluirUsuario(usuarioId) {
            if (!confirm('Tem certeza que deseja excluir este usu√°rio? Esta a√ß√£o n√£o pode ser desfeita e todos os registros do usu√°rio ser√£o perdidos.')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/usuarios/${usuarioId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('‚úÖ ' + data.message, 'success');
                    carregarUsuarios();
                    carregarEstatisticas();
                } else {
                    showAlert('‚ùå ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('Erro ao excluir usu√°rio:', error);
                showAlert('‚ùå Erro ao excluir usu√°rio', 'danger');
            }
        }

        // Redefinir senha do usu√°rio - AGORA COM SENHA PADR√ÉO 123456
        async function redefinirSenha(usuarioId) {
            if (!confirm('Deseja redefinir a senha deste usu√°rio? A nova senha ser√°: 123456')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/redefinir-senha', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        usuario_id_reset: usuarioId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`‚úÖ ${data.message}`, 'success');
                } else {
                    showAlert('‚ùå ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('Erro ao redefinir senha:', error);
                showAlert('‚ùå Erro ao redefinir senha', 'danger');
            }
        }

        // Carregar registros administrativos
        async function carregarRegistrosAdmin() {
            try {
                const userId = document.getElementById('filter-user').value;
                const startDate = document.getElementById('filter-start').value;
                const endDate = document.getElementById('filter-end').value;

                let url = `/api/admin/registros?limit=200`;
                if (userId) {
                    url += `&usuario_id_filter=${userId}`;
                }
                if (startDate && endDate) {
                    url += `&data_inicio=${startDate}&data_fim=${endDate}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    exibirRegistrosAdmin(data.registros);
                } else {
                    console.error('Erro na resposta da API:', data);
                    showAlert('‚ùå Erro ao carregar registros: ' + (data.error || 'Erro desconhecido'), 'danger');
                }
            } catch (error) {
                console.error('Erro ao carregar registros:', error);
                showAlert('‚ùå Erro ao carregar registros: ' + error.message, 'danger');
            }
        }

        // Exibir registros administrativos
        function exibirRegistrosAdmin(registros) {
            const tbody = document.getElementById('registros-admin-body');
            
            if (registros.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i><br>
                            Nenhum registro encontrado
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = registros.map(registro => `
                <tr>
                    <td>
                        <strong>${registro.usuario_nome}</strong>
                        <br><small class="text-muted">${registro.usuario_cargo}</small>
                    </td>
                    <td>${registro.data}</td>
                    <td>${registro.hora_entrada || '-'}</td>
                    <td>${registro.hora_saida || '-'}</td>
                    <td>${registro.local || '-'}</td>
                    <td>${registro.observacao || '-'}</td>
                    <td>${registro.horas_extras ? '<span class="badge bg-warning">Sim</span>' : 'N√£o'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editarRegistro('${registro.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Editar registro
        async function editarRegistro(registroId) {
            try {
                // Buscar dados do registro
                const response = await fetch(`/api/admin/registros`);
                const data = await response.json();
                
                if (data.success) {
                    const registro = data.registros.find(r => r.id === registroId);
                    if (registro) {
                        document.getElementById('registro-id').value = registro.id;
                        
                        // Converter data para formato YYYY-MM-DD
                        const dataParts = registro.data.split('/');
                        const dataFormatada = `${dataParts[2]}-${dataParts[1]}-${dataParts[0]}`;
                        
                        document.getElementById('edit-data').value = dataFormatada;
                        
                        // Preencher hor√°rios de entrada e sa√≠da para registros normais tamb√©m
                        if (registro.hora_entrada && registro.hora_entrada !== '-') {
                            document.getElementById('edit-hora-entrada').value = registro.hora_entrada;
                        }
                        if (registro.hora_saida && registro.hora_saida !== '-') {
                            document.getElementById('edit-hora-saida').value = registro.hora_saida;
                        }
                        
                        document.getElementById('edit-local').value = registro.local || '';
                        document.getElementById('edit-observacao').value = registro.observacao || '';
                        document.getElementById('edit-horas-extras').checked = registro.horas_extras;
                        
                        const modal = new bootstrap.Modal(document.getElementById('modalEditarRegistro'));
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar registro:', error);
                showAlert('‚ùå Erro ao carregar registro', 'danger');
            }
        }

        // Salvar edi√ß√£o do registro
        async function salvarEdicaoRegistro() {
            try {
                const formData = {
                    data_custom: document.getElementById('edit-data').value,
                    hora_entrada: document.getElementById('edit-hora-entrada').value,
                    hora_saida: document.getElementById('edit-hora-saida').value,
                    local: document.getElementById('edit-local').value,
                    observacao: document.getElementById('edit-observacao').value,
                    horas_extras: document.getElementById('edit-horas-extras').checked
                };

                const registroId = document.getElementById('registro-id').value;

                const response = await fetch(`/api/admin/registros/${registroId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('‚úÖ ' + data.message, 'success');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarRegistro'));
                    modal.hide();
                    carregarRegistrosAdmin();
                } else {
                    showAlert('‚ùå ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('Erro ao salvar registro:', error);
                showAlert('‚ùå Erro ao salvar registro', 'danger');
            }
        }

        // Excluir registro (admin)
        async function excluirRegistroAdmin() {
            const registroId = document.getElementById('registro-id').value;
            
            if (!confirm('Tem certeza que deseja excluir este registro? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/registros/${registroId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('‚úÖ ' + data.message, 'success');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarRegistro'));
                    modal.hide();
                    carregarRegistrosAdmin();
                } else {
                    showAlert('‚ùå ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('Erro ao excluir registro:', error);
                showAlert('‚ùå Erro ao excluir registro', 'danger');
            }
        }

        // Exportar dados para Excel
        async function exportarDadosExcel() {
            try {
                const userId = document.getElementById('filter-user').value;
                const startDate = document.getElementById('filter-start').value;
                const endDate = document.getElementById('filter-end').value;

                let url = `/api/admin/exportar-excel`;
                const params = new URLSearchParams();
                
                if (userId) params.append('usuario_id_filter', userId);
                if (startDate) params.append('data_inicio', startDate);
                if (endDate) params.append('data_fim', endDate);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }

                window.open(url, '_blank');
                showAlert('üìä Exporta√ß√£o para Excel iniciada', 'info');
            } catch (error) {
                console.error('Erro ao exportar Excel:', error);
                showAlert('‚ùå Erro ao exportar Excel', 'danger');
            }
        }

        // Exportar dados para PDF - NOVA FUN√á√ÉO
        async function exportarDadosPDF() {
            try {
                const userId = document.getElementById('filter-user').value;
                const startDate = document.getElementById('filter-start').value;
                const endDate = document.getElementById('filter-end').value;

                let url = `/api/admin/exportar-pdf`;
                const params = new URLSearchParams();
                
                if (userId) params.append('usuario_id_filter', userId);
                if (startDate) params.append('data_inicio', startDate);
                if (endDate) params.append('data_fim', endDate);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }

                window.open(url, '_blank');
                showAlert('üìÑ Exporta√ß√£o para PDF iniciada', 'info');
            } catch (error) {
                console.error('Erro ao exportar PDF:', error);
                showAlert('‚ùå Erro ao exportar PDF', 'danger');
            }
        }

        // Fun√ß√µes de relat√≥rios
        async function gerarRelatorioFrequencia() {
            try {
                const usuarioId = document.getElementById('relatorio-usuario').value;
                const dataInicio = document.getElementById('relatorio-data-inicio').value;
                const dataFim = document.getElementById('relatorio-data-fim').value;

                let url = `/api/admin/relatorio-frequencia`;
                const params = new URLSearchParams();
                
                if (usuarioId) params.append('usuario_id', usuarioId);
                if (dataInicio) params.append('data_inicio', dataInicio);
                if (dataFim) params.append('data_fim', dataFim);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }

                window.open(url, '_blank');
                showAlert('üìà Relat√≥rio de frequ√™ncia gerado', 'info');
            } catch (error) {
                console.error('Erro ao gerar relat√≥rio:', error);
                showAlert('‚ùå Erro ao gerar relat√≥rio', 'danger');
            }
        }

        async function gerarRelatorioHorasExtras() {
            try {
                const usuarioId = document.getElementById('relatorio-usuario').value;
                const dataInicio = document.getElementById('relatorio-data-inicio').value;
                const dataFim = document.getElementById('relatorio-data-fim').value;

                let url = `/api/admin/relatorio-horas-extras`;
                const params = new URLSearchParams();
                
                if (usuarioId) params.append('usuario_id', usuarioId);
                if (dataInicio) params.append('data_inicio', dataInicio);
                if (dataFim) params.append('data_fim', dataFim);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }

                window.open(url, '_blank');
                showAlert('‚è∞ Relat√≥rio de horas extras gerado', 'info');
            } catch (error) {
                console.error('Erro ao gerar relat√≥rio:', error);
                showAlert('‚ùå Erro ao gerar relat√≥rio', 'danger');
            }
        }

        async function gerarRelatorioCompleto() {
            try {
                const usuarioId = document.getElementById('relatorio-usuario').value;
                const dataInicio = document.getElementById('relatorio-data-inicio').value;
                const dataFim = document.getElementById('relatorio-data-fim').value;

                let url = `/api/admin/relatorio-completo`;
                const params = new URLSearchParams();
                
                if (usuarioId) params.append('usuario_id', usuarioId);
                if (dataInicio) params.append('data_inicio', dataInicio);
                if (dataFim) params.append('data_fim', dataFim);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }

                window.open(url, '_blank');
                showAlert('üìã Relat√≥rio completo gerado', 'info');
            } catch (error) {
                console.error('Erro ao gerar relat√≥rio:', error);
                showAlert('‚ùå Erro ao gerar relat√≥rio', 'danger');
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('usuario');
            localStorage.removeItem('token');
            window.location.href = 'login';
        }

        // Fun√ß√£o para mostrar alertas
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            
            const alertHTML = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.innerHTML += alertHTML;
            
            // Auto-remover ap√≥s 5 segundos
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.remove();
                }
            }, 5000);
        }

        // Event listeners para modais
        document.getElementById('modalUsuario').addEventListener('show.bs.modal', function () {
            if (!document.getElementById('usuario-id').value) {
                novoUsuario();
            }
        });
    </script>
</body>
</html>