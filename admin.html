<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Sistema de Ponto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            background: #2c3e50;
            color: white;
            height: 100vh;
            position: fixed;
            width: 250px;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        .nav-link {
            color: #bdc3c7;
            padding: 15px 20px;
            border-left: 4px solid transparent;
        }
        .nav-link:hover, .nav-link.active {
            color: white;
            background: #34495e;
            border-left-color: #3498db;
        }
        .nav-link i {
            width: 20px;
            margin-right: 10px;
        }
        .stats-card {
            border-radius: 10px;
            border: none;
            color: white;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            transition: all 0.3s ease;
        }
        #alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
        }
        .badge-admin {
            background: linear-gradient(45deg, #FFD700, #FFA500);
        }
        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .relatorio-card {
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }
        .relatorio-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .table-responsive {
            max-height: 600px;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        #loading-usuarios, #loading-registros {
            display: none;
        }
        #no-users, #no-registros {
            display: none;
        }
        .relatorio-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .relatorio-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-3">
            <h4><i class="fas fa-crown"></i> Painel Admin</h4>
            <hr>
        </div>
        <nav class="nav flex-column">
            <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a class="nav-link" href="#" onclick="showSection('usuarios')">
                <i class="fas fa-users"></i> Gerenciar Usuários
            </a>
            <a class="nav-link" href="#" onclick="showSection('registros')">
                <i class="fas fa-history"></i> Todos os Registros
            </a>
            <a class="nav-link" href="#" onclick="showSection('relatorios')">
                <i class="fas fa-chart-bar"></i> Relatórios
            </a>
            <hr>
            <a class="nav-link text-danger" href="#" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Sair
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Alert Container -->
        <div id="alert-container"></div>

        <!-- Dashboard Section -->
        <div id="dashboard-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard Administrativo</h2>
                <span id="admin-name" class="text-muted">Administrador</span>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stats-card bg-primary card-hover">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h3 id="total-users">0</h3>
                                    <p class="mb-0">Total Usuários</p>
                                </div>
                                <i class="fas fa-users fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card bg-success card-hover">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h3 id="total-registros">0</h3>
                                    <p class="mb-0">Total Registros</p>
                                </div>
                                <i class="fas fa-list fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card bg-warning card-hover">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h3 id="registros-hoje">0</h3>
                                    <p class="mb-0">Registros Hoje</p>
                                </div>
                                <i class="fas fa-calendar-day fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card bg-info card-hover">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h3 id="admin-users">0</h3>
                                    <p class="mb-0">Administradores</p>
                                </div>
                                <i class="fas fa-crown fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="fas fa-bolt"></i> Ações Rápidas</h5>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-success me-2" onclick="showSection('usuarios'); document.getElementById('btn-novo-usuario').click();">
                                <i class="fas fa-user-plus"></i> Novo Usuário
                            </button>
                            <button class="btn btn-primary me-2" onclick="showSection('registros')">
                                <i class="fas fa-search"></i> Ver Registros
                            </button>
                            <div class="export-buttons mt-2">
                                <button class="btn btn-info" onclick="exportarDadosExcel()">
                                    <i class="fas fa-file-excel"></i> Exportar Excel
                                </button>
                                <button class="btn btn-danger" onclick="exportarDadosPDF()">
                                    <i class="fas fa-file-pdf"></i> Exportar PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Usuários Section -->
        <div id="usuarios-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-users"></i> Gerenciar Usuários</h2>
                <button class="btn btn-success" id="btn-novo-usuario" data-bs-toggle="modal" data-bs-target="#modalUsuario">
                    <i class="fas fa-user-plus"></i> Novo Usuário
                </button>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>E-mail</th>
                                    <th>Telefone</th>
                                    <th>Cargo</th>
                                    <th>Status</th>
                                    <th>Cadastro</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="usuarios-body">
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <div class="loading-spinner" id="loading-usuarios">
                                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                                            <p class="mt-2">Carregando usuários...</p>
                                        </div>
                                        <div id="no-users">
                                            <i class="fas fa-users fa-2x mb-2"></i><br>
                                            Nenhum usuário encontrado
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Registros Section -->
        <div id="registros-section" style="display: none;">
            <h2 class="mb-4"><i class="fas fa-history"></i> Todos os Registros</h2>
            
            <div class="card">
                <div class="card-header">
                    <div class="row">
                        <div class="col-md-4">
                            <select class="form-select" id="filter-user">
                                <option value="">Todos os usuários</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="filter-start">
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="filter-end">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="carregarRegistrosAdmin()">
                                <i class="fas fa-filter"></i> Filtrar
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Usuário</th>
                                    <th>Data</th>
                                    <th>Hora Entrada</th>
                                    <th>Hora Saída</th>
                                    <th>Local</th>
                                    <th>Observação</th>
                                    <th>Horas Extras</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="registros-admin-body">
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">
                                        <div class="loading-spinner" id="loading-registros">
                                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                                            <p class="mt-2">Carregando registros...</p>
                                        </div>
                                        <div id="no-registros">
                                            <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                            Nenhum registro encontrado
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Relatórios Section -->
        <div id="relatorios-section" style="display: none;">
            <h2 class="mb-4"><i class="fas fa-chart-bar"></i> Relatórios</h2>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Filtros do Relatório</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="relatorio-usuario" class="form-label">Usuário</label>
                            <select class="form-select" id="relatorio-usuario">
                                <option value="">Todos os usuários</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="relatorio-data-inicio" class="form-label">Data Início</label>
                            <input type="date" class="form-control" id="relatorio-data-inicio">
                        </div>
                        <div class="col-md-3">
                            <label for="relatorio-data-fim" class="form-label">Data Fim</label>
                            <input type="date" class="form-control" id="relatorio-data-fim">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-success w-100" onclick="gerarRelatorio()">
                                <i class="fas fa-play"></i> Gerar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cards de Relatórios -->
            <div class="row mt-4">
                <div class="col-md-6 mb-4">
                    <div class="card relatorio-card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-line"></i> Relatório de Frequência
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Relatório detalhado de frequência por período</p>
                            <div id="relatorio-frequencia">
                                <p class="text-center text-muted">Selecione os filtros e clique em Gerar</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4">
                    <div class="card relatorio-card">
                        <div class="card-header bg-warning text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-clock"></i> Relatório de Horas Extras
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Relatório consolidado de horas extras</p>
                            <div id="relatorio-horas-extras">
                                <p class="text-center text-muted">Selecione os filtros e clique em Gerar</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Relatório Completo -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card relatorio-card">
                        <div class="card-header bg-success text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-file-alt"></i> Relatório Completo
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Usuário</th>
                                            <th>Data</th>
                                            <th>Tipo</th>
                                            <th>Entrada</th>
                                            <th>Saída</th>
                                            <th>Horas Trabalhadas</th>
                                            <th>Horas Extras</th>
                                            <th>Local</th>
                                        </tr>
                                    </thead>
                                    <tbody id="relatorio-completo-body">
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">
                                                Selecione os filtros e clique em Gerar
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Usuário -->
    <div class="modal fade" id="modalUsuario" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalUsuarioTitle">Novo Usuário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-usuario">
                        <input type="hidden" id="usuario-id">
                        <div class="mb-3">
                            <label for="nome" class="form-label">Nome *</label>
                            <input type="text" class="form-control" id="nome" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">E-mail *</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="telefone" class="form-label">Telefone</label>
                            <input type="tel" class="form-control" id="telefone">
                        </div>
                        <div class="mb-3">
                            <label for="cargo" class="form-label">Cargo</label>
                            <input type="text" class="form-control" id="cargo" value="Terceiro">
                        </div>
                        <div class="mb-3">
                            <label for="senha" class="form-label">Senha *</label>
                            <input type="password" class="form-control" id="senha" required minlength="6">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="is-admin">
                            <label class="form-check-label" for="is-admin">
                                É administrador
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarUsuario()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Registro -->
    <div class="modal fade" id="modalEditarRegistro" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Registro de Ponto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-editar-registro">
                        <input type="hidden" id="registro-id">
                        <div class="mb-3">
                            <label for="edit-data" class="form-label">Data</label>
                            <input type="date" class="form-control" id="edit-data">
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="edit-hora-entrada" class="form-label">Hora Entrada</label>
                                <input type="time" class="form-control" id="edit-hora-entrada">
                            </div>
                            <div class="col-md-6">
                                <label for="edit-hora-saida" class="form-label">Hora Saída</label>
                                <input type="time" class="form-control" id="edit-hora-saida">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="edit-local" class="form-label">Local</label>
                            <input type="text" class="form-control" id="edit-local">
                        </div>
                        <div class="mb-3">
                            <label for="edit-observacao" class="form-label">Observação</label>
                            <textarea class="form-control" id="edit-observacao" rows="3"></textarea>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="edit-horas-extras">
                            <label class="form-check-label" for="edit-horas-extras">
                                Horas Extras
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarEdicaoRegistro()">Salvar Alterações</button>
                    <button type="button" class="btn btn-danger" onclick="excluirRegistroAdmin()">Excluir Registro</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ========== FUNÇÕES DO PAINEL ADMIN ==========

        let usuariosList = [];
        let registrosList = [];

        // Função para mostrar alertas
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            
            const alertHTML = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.innerHTML += alertHTML;
            
            // Auto-remover após 5 segundos
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.remove();
                }
            }, 5000);
        }

        // Função de logout - CORRIGIDA
        function logout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                // Limpar qualquer dado de sessão
                localStorage.removeItem('user');
                localStorage.removeItem('token');
                localStorage.removeItem('currentUser');
                sessionStorage.clear();
                
                // Redirecionar para a página de login
                window.location.href = '/login';
            }
        }

        // Função para gerar relatório - IMPLEMENTADA
        async function gerarRelatorio() {
            try {
                const usuarioId = document.getElementById('relatorio-usuario').value;
                const dataInicio = document.getElementById('relatorio-data-inicio').value;
                const dataFim = document.getElementById('relatorio-data-fim').value;

                if (!dataInicio || !dataFim) {
                    showAlert('❌ Selecione o período do relatório', 'warning');
                    return;
                }

                showAlert('📊 Gerando relatórios...', 'info');

                // Gerar relatório de frequência
                const frequenciaResponse = await fetch(`/api/admin/relatorios/frequencia?usuario_id=${usuarioId || ''}&data_inicio=${dataInicio}&data_fim=${dataFim}`);
                const frequenciaData = await frequenciaResponse.json();

                // Gerar relatório de horas extras
                const horasExtrasResponse = await fetch(`/api/admin/relatorios/horas-extras?usuario_id=${usuarioId || ''}&data_inicio=${dataInicio}&data_fim=${dataFim}`);
                const horasExtrasData = await horasExtrasResponse.json();

                // Gerar relatório completo
                const completoResponse = await fetch(`/api/admin/relatorios/completo?usuario_id=${usuarioId || ''}&data_inicio=${dataInicio}&data_fim=${dataFim}`);
                const completoData = await completoResponse.json();

                if (frequenciaData.success && horasExtrasData.success && completoData.success) {
                    exibirRelatorioFrequencia(frequenciaData.relatorio);
                    exibirRelatorioHorasExtras(horasExtrasData.relatorio);
                    exibirRelatorioCompleto(completoData.relatorio);
                    showAlert('✅ Relatórios gerados com sucesso!', 'success');
                } else {
                    showAlert('❌ Erro ao gerar relatórios', 'danger');
                }

            } catch (error) {
                console.error('❌ Erro ao gerar relatório:', error);
                showAlert('❌ Erro ao gerar relatórios: ' + error.message, 'danger');
            }
        }

        // Exibir relatório de frequência
        function exibirRelatorioFrequencia(dados) {
            const container = document.getElementById('relatorio-frequencia');
            
            if (!dados || dados.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">Nenhum dado encontrado para o período selecionado</p>';
                return;
            }

            let html = '';
            dados.forEach(item => {
                html += `
                    <div class="relatorio-item">
                        <div class="d-flex justify-content-between">
                            <strong>${item.usuario_nome}</strong>
                            <span class="badge bg-primary">${item.data}</span>
                        </div>
                        <div class="small text-muted">
                            Cargo: ${item.usuario_cargo} | 
                            Entradas: ${item.entradas} | 
                            Saídas: ${item.saidas} | 
                            Total: ${item.total_registros} registros
                            ${item.horas_extras > 0 ? `| Horas Extras: ${item.horas_extras}` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Exibir relatório de horas extras
        function exibirRelatorioHorasExtras(dados) {
            const container = document.getElementById('relatorio-horas-extras');
            
            if (!dados || dados.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">Nenhuma hora extra encontrada para o período selecionado</p>';
                return;
            }

            let html = '';
            dados.forEach(item => {
                html += `
                    <div class="relatorio-item">
                        <div class="d-flex justify-content-between">
                            <strong>${item.usuario_nome}</strong>
                            <span class="badge bg-warning">${item.data}</span>
                        </div>
                        <div class="small text-muted">
                            ${item.hora_entrada} às ${item.hora_saida}
                            ${item.observacao ? `| ${item.observacao}` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Exibir relatório completo
        function exibirRelatorioCompleto(dados) {
            const tbody = document.getElementById('relatorio-completo-body');
            
            if (!dados || dados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">Nenhum registro encontrado para o período selecionado</td></tr>';
                return;
            }

            tbody.innerHTML = dados.map(item => `
                <tr>
                    <td>${item.usuario_nome}</td>
                    <td>${item.data}</td>
                    <td><span class="badge ${item.tipo === 'entrada' ? 'bg-success' : item.tipo === 'saida' ? 'bg-danger' : 'bg-info'}">${item.tipo}</span></td>
                    <td>${item.hora_entrada || '-'}</td>
                    <td>${item.hora_saida || '-'}</td>
                    <td>${item.horas_trabalhadas || '-'}</td>
                    <td>${item.horas_extras ? '<span class="badge bg-warning">Sim</span>' : 'Não'}</td>
                    <td>${item.local || '-'}</td>
                </tr>
            `).join('');
        }

        // Verificar autenticação e admin
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar o modal de novo usuário
            const btnNovoUsuario = document.getElementById('btn-novo-usuario');
            if (btnNovoUsuario) {
                btnNovoUsuario.addEventListener('click', function() {
                    document.getElementById('modalUsuarioTitle').textContent = 'Novo Usuário';
                    document.getElementById('form-usuario').reset();
                    document.getElementById('usuario-id').value = '';
                    document.getElementById('senha').required = true;
                    document.getElementById('senha').placeholder = '';
                });
            }
            
            console.log('🔄 Inicializando painel admin...');
            carregarEstatisticas();
            carregarUsuarios();
            carregarRegistrosAdmin();
        });

        // Funções de navegação
        function showSection(sectionName) {
            // Esconder todas as sections
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('usuarios-section').style.display = 'none';
            document.getElementById('registros-section').style.display = 'none';
            document.getElementById('relatorios-section').style.display = 'none';
            
            // Mostrar section selecionada
            document.getElementById(sectionName + '-section').style.display = 'block';
            
            // Atualizar menu
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');

            // Recarregar dados se necessário
            if (sectionName === 'usuarios') {
                carregarUsuarios();
            } else if (sectionName === 'registros') {
                carregarRegistrosAdmin();
            } else if (sectionName === 'relatorios') {
                carregarUsuarios(); // Para popular o filtro de usuários
            }
        }

        // Carregar estatísticas do sistema
        async function carregarEstatisticas() {
            try {
                console.log('📈 Carregando estatísticas...');
                const response = await fetch('/api/admin/estatisticas');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('total-users').textContent = data.estatisticas.totalUsers;
                    document.getElementById('admin-users').textContent = data.estatisticas.totalAdmins;
                    document.getElementById('total-registros').textContent = data.estatisticas.totalRegistros;
                    document.getElementById('registros-hoje').textContent = data.estatisticas.registrosHoje;
                    console.log('✅ Estatísticas carregadas');
                } else {
                    console.error('❌ Erro nas estatísticas:', data.error);
                    showAlert('❌ Erro ao carregar estatísticas: ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('❌ Erro ao carregar estatísticas:', error);
                showAlert('❌ Erro ao carregar estatísticas: ' + error.message, 'danger');
            }
        }

        // Carregar lista de usuários - CORRIGIDA
        async function carregarUsuarios() {
            try {
                console.log('👥 Carregando usuários...');
                
                // Mostrar loading - COM VERIFICAÇÃO DE ELEMENTO
                const loadingElement = document.getElementById('loading-usuarios');
                const noUsersElement = document.getElementById('no-users');
                const tbody = document.getElementById('usuarios-body');
                
                if (loadingElement) loadingElement.style.display = 'block';
                if (noUsersElement) noUsersElement.style.display = 'none';
                if (tbody) tbody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="loading-spinner"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">Carregando usuários...</p></div></td></tr>';

                const response = await fetch('/api/admin/usuarios');
                console.log('📨 Resposta da API:', response.status);
                
                // Verificar se a resposta é JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('❌ Resposta não é JSON:', text.substring(0, 200));
                    throw new Error('Resposta do servidor não é JSON');
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('📊 Dados recebidos:', data);
                
                if (data.success) {
                    usuariosList = data.usuarios;
                    exibirUsuarios(data.usuarios);
                    popularFiltroUsuarios(data.usuarios);
                    popularFiltroRelatorioUsuarios(data.usuarios);
                    console.log('✅ Usuários carregados:', data.usuarios.length);
                } else {
                    console.error('❌ Erro na resposta da API:', data);
                    showAlert('❌ Erro ao carregar usuários: ' + (data.error || 'Erro desconhecido'), 'danger');
                    if (noUsersElement) noUsersElement.style.display = 'block';
                }
            } catch (error) {
                console.error('❌ Erro ao carregar usuários:', error);
                showAlert('❌ Erro ao carregar usuários: ' + error.message, 'danger');
                const noUsersElement = document.getElementById('no-users');
                if (noUsersElement) noUsersElement.style.display = 'block';
            } finally {
                const loadingElement = document.getElementById('loading-usuarios');
                if (loadingElement) loadingElement.style.display = 'none';
            }
        }

        // Exibir usuários na tabela - CORRIGIDA
        function exibirUsuarios(usuarios) {
            const tbody = document.getElementById('usuarios-body');
            const noUsersElement = document.getElementById('no-users');
            
            if (!tbody) {
                console.error('❌ Elemento tbody não encontrado');
                return;
            }
            
            if (!usuarios || usuarios.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-users fa-2x mb-2"></i><br>
                            Nenhum usuário encontrado
                        </td>
                    </tr>
                `;
                if (noUsersElement) noUsersElement.style.display = 'block';
                return;
            }
            
            if (noUsersElement) noUsersElement.style.display = 'none';
            
            tbody.innerHTML = usuarios.map(usuario => `
                <tr>
                    <td>
                        <strong>${usuario.nome}</strong>
                        ${usuario.isAdmin ? '<span class="badge bg-warning ms-1">Admin</span>' : ''}
                    </td>
                    <td>${usuario.email}</td>
                    <td>${usuario.telefone || '-'}</td>
                    <td>${usuario.cargo}</td>
                    <td>
                        <span class="badge ${usuario.status === 'ativo' ? 'bg-success' : 'bg-secondary'}">
                            ${usuario.status}
                        </span>
                    </td>
                    <td>${formatarData(usuario.criadoEm)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editarUsuario('${usuario.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="redefinirSenha('${usuario.id}')">
                            <i class="fas fa-key"></i>
                        </button>
                        ${!usuario.isAdmin ? `
                            <button class="btn btn-sm btn-outline-danger" onclick="excluirUsuario('${usuario.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // Função auxiliar para formatar data
        function formatarData(dataString) {
            if (!dataString) return '-';
            try {
                const data = new Date(dataString);
                return data.toLocaleDateString('pt-BR');
            } catch (error) {
                return '-';
            }
        }

        // Popular filtro de usuários
        function popularFiltroUsuarios(usuarios) {
            const select = document.getElementById('filter-user');
            if (!select) return;
            
            select.innerHTML = '<option value="">Todos os usuários</option>';
            
            usuarios.forEach(usuario => {
                select.innerHTML += `<option value="${usuario.id}">${usuario.nome}</option>`;
            });
        }

        // Popular filtro de relatórios
        function popularFiltroRelatorioUsuarios(usuarios) {
            const select = document.getElementById('relatorio-usuario');
            if (!select) return;
            
            select.innerHTML = '<option value="">Todos os usuários</option>';
            
            usuarios.forEach(usuario => {
                select.innerHTML += `<option value="${usuario.id}">${usuario.nome}</option>`;
            });
        }

        // Abrir modal para novo usuário
        function novoUsuario() {
            document.getElementById('modalUsuarioTitle').textContent = 'Novo Usuário';
            document.getElementById('form-usuario').reset();
            document.getElementById('usuario-id').value = '';
            document.getElementById('senha').required = true;
            document.getElementById('senha').placeholder = '';
        }

        // Editar usuário
        async function editarUsuario(usuarioId) {
            try {
                const usuario = usuariosList.find(u => u.id === usuarioId);
                if (usuario) {
                    document.getElementById('modalUsuarioTitle').textContent = 'Editar Usuário';
                    document.getElementById('usuario-id').value = usuario.id;
                    document.getElementById('nome').value = usuario.nome;
                    document.getElementById('email').value = usuario.email;
                    document.getElementById('telefone').value = usuario.telefone || '';
                    document.getElementById('cargo').value = usuario.cargo;
                    document.getElementById('is-admin').checked = usuario.isAdmin;
                    document.getElementById('senha').required = false;
                    document.getElementById('senha').placeholder = 'Deixe em branco para manter a senha atual';
                    
                    const modal = new bootstrap.Modal(document.getElementById('modalUsuario'));
                    modal.show();
                }
            } catch (error) {
                console.error('❌ Erro ao carregar usuário:', error);
                showAlert('❌ Erro ao carregar usuário', 'danger');
            }
        }

        // Salvar usuário (criar ou editar)
        async function salvarUsuario() {
            try {
                const formData = {
                    nome: document.getElementById('nome').value,
                    email: document.getElementById('email').value,
                    telefone: document.getElementById('telefone').value,
                    cargo: document.getElementById('cargo').value,
                    isAdmin: document.getElementById('is-admin').checked
                };

                // Adicionar senha apenas se for novo usuário ou se foi preenchida
                const senha = document.getElementById('senha').value;
                const usuarioId = document.getElementById('usuario-id').value;
                
                if (!usuarioId && !senha) {
                    showAlert('❌ Senha é obrigatória para novo usuário', 'warning');
                    return;
                }

                if (senha) {
                    formData.senha = senha;
                }

                let response;
                if (usuarioId) {
                    // Editar usuário existente
                    response = await fetch(`/api/admin/usuarios/${usuarioId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                } else {
                    // Criar novo usuário
                    response = await fetch('/api/admin/cadastro', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                }

                const data = await response.json();

                if (data.success) {
                    showAlert('✅ ' + data.message, 'success');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalUsuario'));
                    modal.hide();
                    carregarUsuarios();
                    carregarEstatisticas();
                } else {
                    showAlert('❌ ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('❌ Erro ao salvar usuário:', error);
                showAlert('❌ Erro ao salvar usuário', 'danger');
            }
        }

        // Excluir usuário
        async function excluirUsuario(usuarioId) {
            if (!confirm('Tem certeza que deseja excluir este usuário? Esta ação não pode ser desfeita e todos os registros do usuário serão perdidos.')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/usuarios/${usuarioId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('✅ ' + data.message, 'success');
                    carregarUsuarios();
                    carregarEstatisticas();
                } else {
                    showAlert('❌ ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('❌ Erro ao excluir usuário:', error);
                showAlert('❌ Erro ao excluir usuário', 'danger');
            }
        }

        // Redefinir senha do usuário
        async function redefinirSenha(usuarioId) {
            if (!confirm('Deseja redefinir a senha deste usuário? A nova senha será: 123456')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/redefinir-senha', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        usuario_id_reset: usuarioId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`✅ ${data.message}`, 'success');
                } else {
                    showAlert('❌ ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('❌ Erro ao redefinir senha:', error);
                showAlert('❌ Erro ao redefinir senha', 'danger');
            }
        }

        // Carregar registros administrativos
        async function carregarRegistrosAdmin() {
            try {
                console.log('📊 Carregando registros admin...');
                
                // Mostrar loading - COM VERIFICAÇÃO
                const loadingElement = document.getElementById('loading-registros');
                const noRegistrosElement = document.getElementById('no-registros');
                const tbody = document.getElementById('registros-admin-body');
                
                if (loadingElement) loadingElement.style.display = 'block';
                if (noRegistrosElement) noRegistrosElement.style.display = 'none';
                if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="text-center"><div class="loading-spinner"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">Carregando registros...</p></div></td></tr>';

                const userId = document.getElementById('filter-user')?.value;
                const startDate = document.getElementById('filter-start')?.value;
                const endDate = document.getElementById('filter-end')?.value;

                let url = `/api/admin/registros?limit=200`;
                if (userId) {
                    url += `&usuario_id_filter=${userId}`;
                }
                if (startDate && endDate) {
                    url += `&data_inicio=${startDate}&data_fim=${endDate}`;
                }

                const response = await fetch(url);
                
                // Verificar se é JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('❌ Resposta não é JSON:', text.substring(0, 200));
                    throw new Error('Resposta do servidor não é JSON');
                }
                
                const data = await response.json();

                if (data.success) {
                    registrosList = data.registros;
                    exibirRegistrosAdmin(data.registros);
                    console.log('✅ Registros carregados:', data.registros.length);
                } else {
                    console.error('❌ Erro na resposta da API:', data);
                    showAlert('❌ Erro ao carregar registros: ' + (data.error || 'Erro desconhecido'), 'danger');
                    if (noRegistrosElement) noRegistrosElement.style.display = 'block';
                }
            } catch (error) {
                console.error('❌ Erro ao carregar registros:', error);
                showAlert('❌ Erro ao carregar registros: ' + error.message, 'danger');
                const noRegistrosElement = document.getElementById('no-registros');
                if (noRegistrosElement) noRegistrosElement.style.display = 'block';
            } finally {
                const loadingElement = document.getElementById('loading-registros');
                if (loadingElement) loadingElement.style.display = 'none';
            }
        }

        // Exibir registros administrativos
        function exibirRegistrosAdmin(registros) {
            const tbody = document.getElementById('registros-admin-body');
            const noRegistrosElement = document.getElementById('no-registros');
            
            if (!tbody) {
                console.error('❌ Elemento tbody não encontrado');
                return;
            }
            
            if (registros.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i><br>
                            Nenhum registro encontrado
                        </td>
                    </tr>
                `;
                if (noRegistrosElement) noRegistrosElement.style.display = 'block';
                return;
            }

            if (noRegistrosElement) noRegistrosElement.style.display = 'none';

            tbody.innerHTML = registros.map(registro => `
                <tr>
                    <td>
                        <strong>${registro.usuario_nome}</strong>
                        <br><small class="text-muted">${registro.usuario_cargo}</small>
                    </td>
                    <td>${registro.data}</td>
                    <td>${registro.hora_entrada || '-'}</td>
                    <td>${registro.hora_saida || '-'}</td>
                    <td>${registro.local || '-'}</td>
                    <td>${registro.observacao || '-'}</td>
                    <td>${registro.horas_extras ? '<span class="badge bg-warning">Sim</span>' : 'Não'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editarRegistro('${registro.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Editar registro
        async function editarRegistro(registroId) {
            try {
                const registro = registrosList.find(r => r.id === registroId);
                if (registro) {
                    document.getElementById('registro-id').value = registro.id;
                    
                    // Converter data para formato YYYY-MM-DD
                    const dataParts = registro.data.split('/');
                    const dataFormatada = `${dataParts[2]}-${dataParts[1].padStart(2, '0')}-${dataParts[0].padStart(2, '0')}`;
                    
                    document.getElementById('edit-data').value = dataFormatada;
                    
                    // Preencher horários
                    if (registro.hora_entrada && registro.hora_entrada !== '-') {
                        document.getElementById('edit-hora-entrada').value = registro.hora_entrada;
                    }
                    if (registro.hora_saida && registro.hora_saida !== '-') {
                        document.getElementById('edit-hora-saida').value = registro.hora_saida;
                    }
                    
                    document.getElementById('edit-local').value = registro.local || '';
                    document.getElementById('edit-observacao').value = registro.observacao || '';
                    document.getElementById('edit-horas-extras').checked = registro.horas_extras;
                    
                    const modal = new bootstrap.Modal(document.getElementById('modalEditarRegistro'));
                    modal.show();
                }
            } catch (error) {
                console.error('❌ Erro ao carregar registro:', error);
                showAlert('❌ Erro ao carregar registro', 'danger');
            }
        }

        // Salvar edição do registro
        async function salvarEdicaoRegistro() {
            try {
                const formData = {
                    data_custom: document.getElementById('edit-data').value,
                    hora_entrada: document.getElementById('edit-hora-entrada').value,
                    hora_saida: document.getElementById('edit-hora-saida').value,
                    local: document.getElementById('edit-local').value,
                    observacao: document.getElementById('edit-observacao').value,
                    horas_extras: document.getElementById('edit-horas-extras').checked
                };

                const registroId = document.getElementById('registro-id').value;

                const response = await fetch(`/api/admin/registros/${registroId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('✅ ' + data.message, 'success');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarRegistro'));
                    modal.hide();
                    carregarRegistrosAdmin();
                } else {
                    showAlert('❌ ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('❌ Erro ao salvar registro:', error);
                showAlert('❌ Erro ao salvar registro', 'danger');
            }
        }

        // Excluir registro (admin)
        async function excluirRegistroAdmin() {
            const registroId = document.getElementById('registro-id').value;
            
            if (!confirm('Tem certeza que deseja excluir este registro? Esta ação não pode ser desfeita.')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/registros/${registroId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('✅ ' + data.message, 'success');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarRegistro'));
                    modal.hide();
                    carregarRegistrosAdmin();
                } else {
                    showAlert('❌ ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('❌ Erro ao excluir registro:', error);
                showAlert('❌ Erro ao excluir registro', 'danger');
            }
        }

        // Exportar dados para Excel
        async function exportarDadosExcel() {
            try {
                const userId = document.getElementById('filter-user').value;
                const startDate = document.getElementById('filter-start').value;
                const endDate = document.getElementById('filter-end').value;

                let url = `/api/exportar/excel/admin`;
                const params = new URLSearchParams();
                
                if (userId) params.append('usuario_id_filter', userId);
                if (startDate) params.append('data_inicio', startDate);
                if (endDate) params.append('data_fim', endDate);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }

                window.open(url, '_blank');
                showAlert('📊 Exportação para Excel iniciada', 'info');
            } catch (error) {
                console.error('❌ Erro ao exportar Excel:', error);
                showAlert('❌ Erro ao exportar Excel', 'danger');
            }
        }

        // Exportar dados para PDF
        async function exportarDadosPDF() {
            try {
                const userId = document.getElementById('filter-user').value;
                const startDate = document.getElementById('filter-start').value;
                const endDate = document.getElementById('filter-end').value;

                let url = `/api/exportar/pdf/admin`;
                const params = new URLSearchParams();
                
                if (userId) params.append('usuario_id_filter', userId);
                if (startDate) params.append('data_inicio', startDate);
                if (endDate) params.append('data_fim', endDate);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }

                window.open(url, '_blank');
                showAlert('📄 Exportação para PDF iniciada', 'info');
            } catch (error) {
                console.error('❌ Erro ao exportar PDF:', error);
                showAlert('❌ Erro ao exportar PDF', 'danger');
            }
        }
    </script>
</body>
</html>